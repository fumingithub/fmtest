<#include "../../../common/_public.html"/>
<!-- <div class="bjui-pageHeader" style="background:#FFF;"> -->
<!--     <div class="row" style="height:70px"> -->
<!--         <div class="col-md-6"> -->
<!--             <div class="office"> -->
<!--                 <ul class="offbtn"> -->
<!--                     <li><a id="lbtnSave" onClick="saveRoleList()"><span class="iconbg04"><i class="fa fa-save font24"></i></span>保存</a></li> -->
<!--                     <li><a class="btn-close closecutab"><span class="iconbg03"><i class="fa fa-remove  font24"></i></span>关闭</a> -->
<!--                     </li> -->
<!--                 </ul> -->
<!--             </div> -->
<!--         </div> -->
<!--     </div> -->
<!-- </div> -->
<div class="bjui-pageContent">
    <form action="" name="pagerform" id="resource_assign_dialog" method="post" data-toggle="validate" data-alertmsg="false">
        <input type="hidden" name="roleId" value="${roleId!}">
        <input type="hidden" name="resourceIds" id="resourceIds" value="${resourceIds!}">
        <div style="margin-top:5px;  overflow:hidden;">
            <div class="col-md-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><a>资源列表</a></h3>
                    </div>
                     <div class="panel-body">
		                    <div id="ttdiv" style="width:100%; overflow:auto; float:left;">
							<ul id="resource_assign_Tree" class="ztree ztree_main" simpleData="true" 
							data-toggle="ztree" data-expand-all="false" data-check-enable="true"
					 		>
							<#list entitys as entity>
								<#if "${entity.id}" != "1">
								<li data-id="${entity.id}" data-pid="${entity.parentCode!}"
									data-tabid="${entity.id}" >
			                                ${entity.display}(<#if entity.type=="0">URL</#if><#if entity.type=="1">菜单</#if><#if entity.type=="2">按钮</#if>)</li> 
								</#if>
							</#list>
							</ul>
							</div>	
                	</div>
           	 	</div>
            </div>
        </div>
    </form>
</div>
<div class="bjui-pageFooter">
	<ul>
		<li>
			<button type="button" class="btn-close closecutab" data-icon="close">关闭</button>
		</li>
		<li>
			<button onClick="saveRoleList()" class="btn-default" data-icon="save">保存</button>
		</li>
	</ul>
</div>
<script language="javascript" type="text/javascript">
$(document).on(BJUI.eventType.afterInitUI, function(e) {
	var ids = $("#resourceIds").val();
	if (ids != null && ids.length > 0) {
		var zTree = $.fn.zTree.getZTreeObj("resource_assign_Tree");
		if (zTree != null) {
			var list = ids.split(',');
	   		for (var i = 0; i < list.length; i++) {
	   			var tNode = zTree.getNodesByParam('id',list[i],null);
	   			if (tNode.length > 0 && !tNode[0].checked) {
	   					zTree.checkNode(tNode[0], !tNode[0].checked, true, true);
	   			}
	   		}
   		}
	}
});
function saveRoleList(){debugger;
  var zTree = $.fn.zTree.getZTreeObj("resource_assign_Tree");
  var tNodes = zTree.getCheckedNodes(true);
  if(tNodes.length==0)
	  {
	  $(this).alertmsg('info',"请至少选择一个资源项！");
	  }
  var ids = "";
  for (var i = 0; i < tNodes.length; i++) {
  	if (!tNodes[i].id == "") {
  		ids = ids + tNodes[i].id + ",";
  	}
  }
  	if (ids.endsWith(',')) {
  		ids = ids.substring(0, ids.length - 1);
  	}
  $("#resourceIds").val(ids);
	 $.ajax({
       type: "POST",
       url: "${ctx}/admin/system/resource!auth.do",
       data:$("#resource_assign_dialog").serialize(), // serializes the form's elements.
       success: function(data){
	       $(this).alertmsg('correct',"保存成功！");
	       $(this).dialog("close", $.CurrentDialog);
       }
	
	}); 
} 
</script>